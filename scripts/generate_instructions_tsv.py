#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
读取 assets/recipes/lists/ 下的八大菜系 *.txt（每行一个菜名），
为每道菜生成“详细、可落地的烹饪步骤”，输出到
assets/recipes/instructions/instructions.tsv（含表头 name\tcuisine\tinstructions）。

规则：
- 先查“经典菜专属做法”字典（精写版）；
- 匹配各类“风味模板”：鱼香/麻辣/水煮/干锅/泡椒/藤椒/剁椒/口味/农家小炒/
  白切/清蒸/避风塘/红烧/清炖/糖醋/蟹粉/松鼠/九转/葱烧/扒/清汤/沙茶/红糟/芋泥/太极/
  东坡/龙井/油焖/叫化/葱烤/腌鲜/火腿炖/清炖(徽)/…
- 模板会根据“主料”自动调整腌制/火候/是否勾芡等细节；
- 未命中的，回退到“通用炒菜/炖煮/蒸煮”的默认模板。

注意：
- TSV 的 instructions 字段里用 \\n 表示换行（方便后续 merge 脚本转为真正换行）。
- 你可随时在 SPECIAL_RECIPES 或 STYLE_TEMPLATES 里追加/微调。
"""
import os, re, sys, json
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
LIST_DIR = ROOT / "assets" / "recipes" / "lists"
OUT_DIR  = ROOT / "assets" / "recipes" / "instructions"
OUT_FILE = OUT_DIR / "instructions.tsv"

os.makedirs(OUT_DIR, exist_ok=True)

CUISINE_BY_FILE = {
    "chuancai.txt": "川菜",
    "yuecai.txt": "粤菜",
    "sucai.txt":  "苏菜",
    "zhecai.txt": "浙菜",
    "mincai.txt": "闽菜",
    "xiangcai.txt":"湘菜",
    "huicai.txt": "徽菜",
    "lucai.txt":  "鲁菜",
}

def esc(s: str) -> str:
    # 把真实换行替换为 \n，避免 TSV 换行破表
    return s.replace("\r\n", "\n").replace("\r", "\n").replace("\n", "\\n")

# ------------------------- 经典菜（专属做法） -------------------------
SPECIAL_RECIPES = {
    # 川菜
    "宫保鸡丁": """1) 鸡胸肉切1.5cm丁，加少许盐、料酒、淀粉与少许油抓匀腌10分钟。
2) 调宫保汁：生抽2、老抽1/2、米醋2、糖3、盐少许、淀粉少许、清水3、花椒油少许。
3) 花生米冷油小火炸酥捞出；锅中留底油，下干辣椒节与花椒小火炒香。
4) 大火下鸡丁滑散至变色，倒入宫保汁翻炒，迅速收浓。
5) 起锅前下葱段与花生米，翻匀出锅。""",
    "麻婆豆腐": """1) 嫩豆腐切2cm方块，开水加盐轻焯30秒捞出备用；牛/猪肉末少许。
2) 郫县豆瓣剁细，蒜姜末、花椒粉、葱花备好；调芡水：生抽1、糖1/2、淀粉与清水适量。
3) 锅中宽油小火炒豆瓣至出红油，下肉末炒散，再下蒜姜末与花椒粉。
4) 倒入热水或高汤，轻推入豆腐，小火微沸5分钟入味。
5) 淋芡水轻轻晃锅至汤汁微稠，撒葱花，淋花椒油出锅。""",
    "回锅肉": """1) 五花肉冷水入锅加姜葱与料酒，小火煮至筷子能插入，晾凉切0.3cm薄片。
2) 青蒜切段、郫县豆瓣与甜面酱各1勺备用。
3) 锅不放油中小火煸肉片出油卷边，推一旁，下豆瓣炒红油，再加甜面酱、生抽少许炒匀。
4) 下青蒜大火翻炒断生，少许糖提鲜，出锅前点醋去腥提香。""",
    "水煮鱼": """1) 草鱼片厚约4mm，盐+料酒+淀粉抓匀腌10分钟；豆芽/莴笋垫底。
2) 郫县豆瓣+干辣椒+花椒炒红油，加高汤煮开，调盐与糖。
3) 下鱼片滑散断生即捞起铺在蔬菜上；原汤过滤后浇上。
4) 另起锅烧热油，撒上干辣椒节与花椒，泼在鱼面；撒蒜末与葱花。""",
    "重庆小面": """1) 碗底：生抽2、老抽1/2、香醋1、盐与味精少许、花椒面、蒜水、葱花、熟芝麻。
2) 辣油：豆瓣小火炒香加辣椒粉与花椒粉，浇入热油静置成红油。
3) 面条大火煮至断生，迅速入碗；加滚烫骨汤或清水，拌匀即可；可加芽菜碎/油渣。""",
    "红油抄手": """1) 猪肉馅加盐/生抽/料酒/姜水/少许油拌匀；抄手皮包好。
2) 红油碗底：生抽、陈醋、糖、蒜末、花椒面、辣油、葱花、少量热油。
3) 抄手入沸水煮至浮起熟透，捞入碗底拌匀，撒葱花与熟芝麻。""",
    "蒜泥白肉": """1) 五花肉整块冷水下锅加姜葱与料酒，小火煮至筷子易插入，冷却后切薄片。
2) 蒜泥加生抽、香醋、糖、辣椒油、花椒油、少量冷开水调成汁。
3) 黄瓜/豆芽垫底，铺肉片，淋蒜泥，点红油与葱花。""",
    "椒麻鸡": """1) 鸡腿冷水下锅加姜葱与盐，小火煮12~15分钟，关火焖10分钟，取出冰水过凉后切块。
2) 调汁：花椒油2、鲜花椒碎、盐、糖少许、蒜末、葱花、香菜末、少量鸡汤或凉开水。
3) 浇在鸡块上拌匀即可。""",
    # 粤菜
    "白切鸡": """1) 三黄鸡冷水下锅，加姜葱与少许盐，小火微沸15~18分钟。
2) 关火加盖焖10分钟，捞出过冰水至完全冷却，表皮紧致。
3) 斩块装盘。蘸碟：蒜蓉+姜末+葱花+热油+盐+生抽少许调匀。""",
    "清蒸鲈鱼": """1) 鲈鱼杀洗干净，身斜刀两刀，抹盐少许，鱼腹垫姜丝。
2) 大火蒸6~8分钟（视大小），出锅倒去蒸汁；铺葱丝姜丝。
3) 淋热油激香，另起锅烧开蒸鱼豉油，沿边淋上即可。""",
    "干炒牛河": """1) 河粉掰散备用；牛肉逆纹切片，生抽/蚝油/糖/胡椒/淀粉/少油抓匀。
2) 大火热锅多油，下牛肉快炒至变色盛出。
3) 锅留油，下蒜片与韭黄、洋葱爆香，入河粉翻炒，调生抽与老抽上色。
4) 回锅牛肉，快炒均匀，临出锅洒少许葱段。""",
    "叉烧": """1) 梅花肉条腌：叉烧酱/生抽/蚝油/蒜末/糖/蜂蜜/绍酒，冷藏腌过夜。
2) 烤箱200℃上下火，烤15分钟后刷蜂蜜水，再烤10~15分钟至表面微焦。
3) 静置5分钟再切片，蘸汁为腌料加热收浓。""",
    "豉汁蒸排骨": """1) 排骨加盐/糖/生抽/蚝油/蒜末/豆豉/胡椒/少许淀粉抓匀腌30分钟。
2) 高火蒸12~15分钟至软糯入味，出锅撒葱花。""",
    "咕噜肉": """1) 里脊块加盐/胡椒/生抽/料酒腌10分钟，拍干粉或裹脆浆。
2) 下油锅中高火炸至外壳定型捞出，复炸至金脆。
3) 锅留少油，下番茄酱/白醋/糖/菠萝块/彩椒段调成咕噜汁，回锅肉块快速翻匀。""",
    # 苏浙闽鲁徽湘等典型几个
    "松鼠桂鱼": """1) 桂鱼去骨去刺保留尾，鱼身打十字花刀并擦干。
2) 先挂薄层干粉，下180℃油温炸至定型，再升至200℃复炸至金黄。
3) 另起锅：糖醋汁（番茄酱/糖/醋/少许盐/清水/淀粉），煮至透亮。
4) 鱼摆盘成松鼠状，淋上糖醋汁，撒松仁/青豆点缀。""",
    "东坡肉": """1) 五花肉整块焯水后擦干，改见方；砂锅垫葱姜。
2) 砂糖炒成糖色，放肉块上色；加黄酒足量、生抽/老抽少许、葱姜、八角。
3) 盖小火焖2~3小时至软糯，汤汁粘亮即成。""",
    "龙井虾仁": """1) 河虾仁挑筋洗净，盐/糖/蛋清/湿淀粉/少许油抓匀。
2) 龙井茶叶用80℃热水泡出茶汤与茶叶。
3) 温油滑炒虾仁至八成熟盛出；锅留底油，下茶叶略爆，倒入茶汤与虾仁，勾薄芡即出。""",
    "佛跳墙": """1) 海参/鲍鱼/瑶柱/蹄筋/花菇/干贝/排骨等提前泡发与焯水。
2) 砂锅垫猪肉皮与老母鸡，分层码放主料，加入绍兴黄酒与清汤。
3) 小火密封焖煮3~4小时至味融，起锅前少许盐调味。""",
    "荔枝肉": """1) 五花肉切厚片，以糖/醋比例偏甜酸腌片刻；挂糊炸至金黄。
2) 锅内调糖醋汁（糖>醋>酱油），下肉片与菠萝/彩椒翻匀收亮。""",
    "姜母鸭": """1) 老姜拍碎爆香，下鸭块煸至出油。
2) 加红枣/枸杞/米酒与少量酱油，小火焖至软烂，汤成姜香酒气。""",
    "剁椒鱼头": """1) 花鲢鱼头对剖洗净，抹盐与料酒，垫姜蒜。
2) 铺满自制剁椒与蒸鱼豉油，大火蒸8~10分钟；出锅撒葱花浇热油。""",
    "毛氏红烧肉": """1) 五花肉块焯水后擦干；炒糖色至琥珀，下肉煸匀上色。
2) 加生抽/老抽/料酒/八角/姜片/开水，小火焖至软糯。
3) 大火收汁至浓亮，略带甜咸，以米酒提香。""",
    "九转大肠": """1) 大肠多次清洗焯水去腥，切段。
2) 炒糖色至枣红，下大肠煸匀，加葱姜蒜/八角/桂皮/黄酒/酱油/适量清水。
3) 小火焖至软烂，勾薄芡，糖醋咸香“九转”层次。""",
    "霉干菜扣肉": """1) 五花肉整块焯后刮净，皮面抹老抽炸至起泡，切厚片。
2) 霉干菜洗净泡发炒香；碗内皮向下码肉与霉干菜。
3) 浇酱汁（生抽/老抽/糖/黄酒），上笼蒸2小时，倒扣成型。""",
}

# ------------------------- 风味模板 -------------------------
def t(*lines): return "\n".join(lines)

def base_protein_tip(main: str) -> str:
    # 简单判断肉/鱼/素，用于模板话术微调
    if any(k in main for k in ("鱼","虾","带子","鲍","鳝","蟹")):
        return "加少许盐、料酒与淀粉抓匀去腥"
    if any(k in main for k in ("鸡","鸭","鹅")):
        return "加少许盐、料酒、胡椒与淀粉抓匀"
    if any(k in main for k in ("牛","羊","猪","肠","肚","肝","里脊")):
        return "加少许盐、料酒、生抽与淀粉抓匀"
    return "加少许盐与油拌匀"

def style_yuxiang(main):  # 鱼香
    return t(
        f"1) 主料处理：{main}切条/片，{base_protein_tip(main)}，腌10分钟；辅料如木耳/笋/胡萝卜按需切条。",
        "2) 调鱼香汁：生抽2、老抽1/2、米醋2、白糖3、郫县豆瓣1、蒜姜末各适量、清水与淀粉调稀。",
        "3) 锅中少油，下豆瓣小火炒红油，入蒜姜与泡椒末炒香。",
        f"4) 下{main}大火快炒至变色，加入辅料翻匀。",
        "5) 沿锅边倒入鱼香汁，翻炒至汤汁浓亮、均匀裹附，出锅。"
    )

def style_mala(main):  # 麻辣
    return t(
        f"1) {main}切块/段，{base_protein_tip(main)}；干辣椒段、花椒粒、蒜片、姜片、葱段备好。",
        "2) 锅入少许底油，小火炒香花椒与干辣椒，出香不糊。",
        f"3) 下{main}大火翻炒至断生，烹生抽/料酒，少许糖提味。",
        "4) 继续翻炒至入味，可加少量高汤，收至微干；撒葱段芝麻。"
    )

def style_shuizhu(main):  # 水煮
    return t(
        f"1) {main}切片/段，{base_protein_tip(main)}；豆芽/莴笋等蔬菜焯水垫底。",
        "2) 郫县豆瓣+干辣椒+花椒炒出红油，加高汤煮沸调咸淡。",
        f"3) 下{main}滑散至断生捞出，铺在蔬菜上；原汤过滤浇上。",
        "4) 另起锅烧热油，撒干辣椒与花椒，趁热泼在表面，撒蒜末葱花。"
    )

def style_ganguo(main):  # 干锅
    return t(
        f"1) {main}预处理：肉类先腌后滑油/焯水，蔬菜如洋葱/芹菜/藕片备好。",
        "2) 锅中底油，下豆瓣/辣椒面/花椒炒香，少许火锅底料增香。",
        f"3) 下{main}翻炒断生，加入配菜大火煸香。",
        "4) 调入生抽/老抽/糖/少量高汤，收至干香，撒葱段与芝麻，上桌可置小炉保温。"
    )

def style_paojiao(main):  # 泡椒
    return t(
        f"1) {main}切块/段，{base_protein_tip(main)}；泡椒切碎、泡椒汁留用。",
        "2) 爆香姜蒜，下泡椒炒出酸辣味。",
        f"3) 下{main}快炒，烹少量泡椒汁与生抽，加入少许糖平衡。",
        "4) 出锅前点少量香醋与葱段，味鲜开胃。"
    )

def style_tengjiao(main):  # 藤椒
    return t(
        f"1) {main}处理并腌制；藤椒（青花椒）用温油浸香，取藤椒油。",
        "2) 锅中下藤椒油与少量生姜蒜，炒至清香。",
        f"3) 下{main}快炒，烹少量鸡汤/清水，加盐与白胡椒调味。",
        "4) 出锅前再淋藤椒油，口味清香麻爽。"
    )

def style_duojiao(main):  # 剁椒蒸
    return t(
        f"1) {main}改刀放盘，抹少许盐/料酒；铺上姜蒜末与足量剁椒。",
        "2) 大火入笼蒸熟（鱼8~10分钟、肉10~15分钟，视原料而定）。",
        "3) 出锅撒葱花，浇少许热油激香，沿边淋蒸鱼豉油。"
    )

def style_kouwei(main):  # 口味（湘菜重口）
    return t(
        f"1) {main}切块/片腌制；小米辣/二荆条/蒜姜切碎。",
        "2) 下油爆香辣椒与蒜姜，放入主料大火快炒，烹生抽/老抽与少量醋。",
        "3) 加少量清水或高汤，收汁见油亮，咸辣香重。"
    )

def style_nongjia_xiaochao(main):
    return t(
        f"1) {main}切薄片腌制；青红椒大量切圈，蒜姜拍碎。",
        "2) 猛火热锅宽油，下主料迅速滑散，随即下辣椒圈爆香。",
        "3) 调生抽/盐/少许糖，略收汁出锅，保持“镬气”。"
    )

def style_baiqie(main):
    return t(
        f"1) {main}冷水入锅，加姜葱与盐，小火微沸至熟（禽类15~20分钟，肉类视情况）。",
        "2) 出锅过冰水至冷却后切件；蘸碟：姜葱蒜末+热油+盐+生抽少许。"
    )

def style_qingzheng(main):
    return t(
        f"1) {main}处理干净，抹盐，垫姜丝葱段。",
        "2) 大火蒸熟（鱼类6~8分钟、贝类3~5分钟、肉类10~15分钟）。",
        "3) 倒去蒸汁，铺葱丝淋热油，配蒸鱼豉油。"
    )

def style_bifengtang(main):
    return t(
        f"1) {main}裹生粉炸至金黄酥脆备用；蒜蓉、面包糠/麦片、椒盐备好。",
        "2) 锅少油中小火炒蒜蓉至金黄，入面包糠与椒盐炒香。",
        "3) 回投主料快速翻匀，离火保持干香酥脆。"
    )

def style_hongshao(main):
    return t(
        f"1) {main}焯水或腌制备用；炒糖色至琥珀，下主料上色。",
        "2) 加生抽/老抽/黄酒/姜葱与热水，小火焖至软烂。",
        "3) 大火收汁至浓亮，口味微甜咸香。"
    )

def style_qingdun(main):
    return t(
        f"1) 砂锅放{main}与姜葱、少许料酒，倒入清水或高汤。",
        "2) 小火慢炖至软烂清鲜，调盐即可；强调汤清味醇，不重色。"
    )

def style_tangcu(main):
    return t(
        f"1) {main}处理后干煎/炸至定型；",
        "2) 调糖醋汁（糖:醋≈2:1，酱油少许、清水与淀粉），入锅煮至透亮；",
        "3) 回锅裹匀翻炒，酸甜开胃。"
    )

def style_xiefen(main):
    return t(
        f"1) 蟹黄/蟹粉与葱姜爆香，加黄酒与高汤略熬；",
        f"2) 下{main}（或提前处理好的丸子/豆腐/小排等），微火煨入味；",
        "3) 以盐/糖调味，勾薄芡，淋上猪油或鸡油提香。"
    )

def style_songshu(main):  # 松鼠
    return t(
        f"1) {main}打花刀擦干，挂薄粉入油锅炸至金黄，复炸更酥；",
        "2) 糖醋番茄汁煮至透亮；",
        "3) 摆形后淋汁，脆皮裹酸甜。"
    )

def style_jiuzhuan(main):
    return t(
        f"1) {main}反复清洗焯水去腥；",
        "2) 炒糖色，下主料与葱姜蒜、黄酒、八角桂皮，加入酱油与清水小火焖；",
        "3) 以糖和醋反复调味，收汁浓亮，层次甘香酸甜。"
    )

def style_congshao(main):
    return t(
        f"1) 大量大葱段小火炸至微焦出香；",
        f"2) 入{main}与生抽/老抽/糖/黄酒/高汤，小火焖至葱香入骨；",
        "3) 出锅前略收汁。"
    )

def style_ba(main):  # 扒
    return t(
        f"1) {main}先煎至定型，再加清汤与少许盐、胡椒；",
        "2) 小火煨至软嫩，原汤勾薄芡，口味清雅。"
    )

def style_qingtang(main):
    return t(
        f"1) 上好清汤与{main}同煮，小火保持清亮不混；",
        "2) 以盐与胡椒轻调味，突出本味。"
    )

def style_shacha(main):
    return t(
        f"1) {main}切块/片，{base_protein_tip(main)}；",
        "2) 沙茶酱与蒜末小火炒香，烹黄酒与少量高汤；",
        "3) 下主料与蔬菜同炒或小火煨，咸香带花生与海鲜风味。"
    )

def style_hongzao(main):
    return t(
        f"1) 红糟与蒜姜拌匀，下{main}略腌；",
        "2) 小火炒香后加汤煨熟，以糖与盐调味；",
        "3) 红糟微酸甜并带酒香。"
    )

def style_yuni(main):
    return t(
        f"1) 芋头蒸熟压泥，与猪油/糖/少许椰奶拌至细腻；",
        f"2) {main}处理后与芋泥同装，或芋泥做底，主料做浇头；",
        "3) 口感绵润，偏甜咸。"
    )

def style_taiji(main):
    return t(
        "1) 准备两色料：白汤（清淡）与红汤（如沙茶/红糟）；",
        f"2) {main}分别在两色料中加热至熟；",
        "3) 分区装盘形成黑白对比，咸鲜带一轻一重两味。"
    )

def style_dongpo(main):
    return t(
        f"1) {main}先焯后上色，黄酒为主、少量生抽老抽与糖，小火焖至软糯；",
        "2) 汤色红亮味厚，偏甜咸。"
    )

def style_longjing(main):
    return t(
        "1) 龙井茶以80℃热水泡出茶汤；",
        f"2) {main}以蛋清与湿淀粉抓匀，温油滑至八成熟；",
        "3) 入茶汤略勾薄芡，清香怡人。"
    )

def style_youmen(main):
    return t(
        f"1) {main}与葱姜蒜同炒，加入生抽/老抽/糖，注少量高汤；",
        "2) 小火焖至油润透亮，咸鲜偏甜。"
    )

def style_jiaohua(main):
    return t(
        f"1) {main}腌好后包入荷叶或泥封，外层再包锡纸；",
        "2) 入烤箱或窑烤至熟透，拆封即食，肉香叶香融合。"
    )

def style_congkao(main):
    return t(
        f"1) 大量葱段入油煸香，下{main}煎至上色；",
        "2) 加酱油/黄酒与少量糖，小火焖至软烂，葱香浓郁。"
    )

def style_yanxian(main):
    return t(
        f"1) {main}与咸鲜配料（火腿/咸肉/咸菜）同煨；",
        "2) 高汤/清水小火慢炖，强调“咸鲜本味”，最后轻调盐。"
    )

def style_ham_stew(main):
    return t(
        f"1) 金华火腿与{main}同入砂锅，加清汤；",
        "2) 小火慢炖至食材彼此增鲜，汤体清润，盐量从轻。"
    )

STYLE_TEMPLATES = [
    (r"^鱼香(.+)$", style_yuxiang),
    (r"^麻辣(.+)$", style_mala),
    (r"^水煮(.+)$", style_shuizhu),
    (r"^干锅(.+)$", style_ganguo),
    (r"^泡椒(.+)$", style_paojiao),
    (r"^藤椒(.+)$", style_tengjiao),
    (r"^剁椒(.+)$", style_duojiao),
    (r"^口味(.+)$", style_kouwei),
    (r"^农家小炒(.+)$", style_nongjia_xiaochao),
    (r"^小炒(.+)$", style_nongjia_xiaochao),

    (r"^白切(.+)$", style_baiqie),
    (r"^清蒸(.+)$", style_qingzheng),
    (r"^避风塘(.+)$", style_bifengtang),

    (r"^红烧(.+)$", style_hongshao),
    (r"^清炖(.+)$", style_qingdun),
    (r"^糖醋(.+)$", style_tangcu),
    (r"^蟹粉(.+)$", style_xiefen),
    (r"^松鼠(.+)$", style_songshu),

    (r"^九转(.+)$", style_jiuzhuan),
    (r"^葱烧(.+)$", style_congshao),
    (r"^扒(.+)$", style_ba),
    (r"^清汤(.+)$", style_qingtang),

    (r"^沙茶(.+)$", style_shacha),
    (r"^红糟(.+)$", style_hongzao),
    (r"^芋泥(.+)$", style_yuni),
    (r"^太极(.+)$", style_taiji),

    (r"^东坡(.+)$", style_dongpo),
    (r"^龙井(.+)$", style_longjing),
    (r"^油焖(.+)$", style_youmen),
    (r"^叫化(.+)$", style_jiaohua),
    (r"^葱烤(.+)$", style_congkao),

    (r"^腌鲜(.+)$", style_yanxian),
    (r"^火腿炖(.+)$", style_ham_stew),
]

DEFAULT_BY_CUISINE = {
    "川菜": t(
        "1) 主料改刀并腌制（盐/料酒/少许生抽/淀粉）。",
        "2) 锅中下豆瓣/干辣椒/花椒炒香，入主料大火快炒。",
        "3) 以生抽/糖/少量醋调味，收汁见油亮即成。"
    ),
    "湘菜": t(
        "1) 主料切片/块腌制；小米辣/蒜姜切碎。",
        "2) 猛火爆香辣椒与蒜姜，下主料快炒，少量酱油与醋提味。",
        "3) 收汁微干，保持镬气。"
    ),
    "粤菜": t(
        "1) 主料走油滑炒或清蒸清炖为主，突出原味。",
        "2) 调味简洁：盐、胡椒、蒸鱼豉油、葱姜油为主。",
        "3) 火候准确不过分收汁。"
    ),
    "苏菜": t(
        "1) 注重刀工与火候，口味偏甜咸适中。",
        "2) 爆炒/红烧/清炖皆可，汤汁多清亮或糖醋透亮。",
        "3) 勾薄芡保持清爽不腻。"
    ),
    "浙菜": t(
        "1) 注重清鲜与本味，茶香/酒香/醋香常见。",
        "2) 多用清蒸/葱烤/东坡类红烧，口味不厚重。",
        "3) 汤汁讲究清澈与粘亮度。"
    ),
    "闽菜": t(
        "1) 讲究汤与海味互相增鲜，常用沙茶/红糟等调味。",
        "2) 文火慢炖，口味鲜甜略酸香。"
    ),
    "徽菜": t(
        "1) 慢火焖炖见长，擅用咸鲜与山珍笋干。",
        "2) 火腿/咸肉提鲜，口味厚实不腻。"
    ),
    "鲁菜": t(
        "1) 善爆善烹，葱烧/清汤/糖醋俱全。",
        "2) 火候到位，注重汤汁清亮与味厚。"
    ),
}

def gen_by_style(name: str, cuisine: str) -> str:
    # 经典菜命中
    if name in SPECIAL_RECIPES:
        return SPECIAL_RECIPES[name]
    # 模板匹配（按顺序）
    for pat, fn in STYLE_TEMPLATES:
        m = re.match(pat, name)
        if m:
            main = m.group(1)
            return fn(main)
    # 未命中：给出菜系默认版
    return DEFAULT_BY_CUISINE.get(cuisine, DEFAULT_BY_CUISINE["川菜"])

def load_names():
    items = []
    for fn, cui in CUISINE_BY_FILE.items():
        path = LIST_DIR / fn
        if not path.exists(): 
            continue
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                nm = line.strip()
                if nm and not nm.startswith("#"):
                    items.append((nm, cui))
    # 去重（同名同菜系）
    seen = set()
    uniq = []
    for nm, cui in items:
        key = (nm, cui)
        if key not in seen:
            seen.add(key)
            uniq.append((nm, cui))
    return uniq

def main():
    items = load_names()
    if not items:
        print(f"No names found in {LIST_DIR}")
        return 0
    with open(OUT_FILE, "w", encoding="utf-8") as out:
        out.write("name\tcuisine\tinstructions\n")
        for nm, cui in items:
            instr = gen_by_style(nm, cui)
            out.write(f"{nm}\t{cui}\t{esc(instr)}\n")
    print(f"Generated: {OUT_FILE} ({len(items)} rows)")
    return 0

if __name__ == "__main__":
    sys.exit(main())
